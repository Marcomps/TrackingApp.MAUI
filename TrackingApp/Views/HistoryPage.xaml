<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:TrackingApp.ViewModels"
             x:Class="TrackingApp.HistoryPage"
             Title="Historial">

    <ContentPage.BindingContext>
        <viewmodels:HistoryViewModel />
    </ContentPage.BindingContext>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- FILTROS GENERALES -->
            <Frame BackgroundColor="#2a3d66" Padding="15" CornerRadius="8" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ” Filtros" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="White"
                           HorizontalOptions="Center"/>
                    
                    <!-- Filtro por perfil -->
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Perfil:" 
                               TextColor="White" 
                               VerticalOptions="Center"
                               WidthRequest="80"/>
                        <Picker ItemsSource="{Binding Profiles}"
                                SelectedItem="{Binding SelectedProfileFilter}"
                                TextColor="White"
                                BackgroundColor="#1a2540"
                                HorizontalOptions="FillAndExpand"/>
                    </HorizontalStackLayout>

                    <!-- Filtro por rango de fechas -->
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="PerÃ­odo:" 
                               TextColor="White" 
                               VerticalOptions="Center"
                               WidthRequest="80"/>
                        <Picker ItemsSource="{Binding DateRangeOptions}"
                                SelectedItem="{Binding SelectedDateRangeFilter}"
                                TextColor="White"
                                BackgroundColor="#1a2540"
                                HorizontalOptions="FillAndExpand"/>
                    </HorizontalStackLayout>

                    <Button Text="ðŸ”„ Actualizar"
                            Command="{Binding RefreshCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            FontAttributes="Bold"
                            HorizontalOptions="Center"
                            WidthRequest="150"/>
                </VerticalStackLayout>
            </Frame>

            <!-- HISTORIAL DE MEDICAMENTOS -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="8" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ’Š Historial de Medicamentos" 
                           FontSize="22" 
                           FontAttributes="Bold" 
                           TextColor="#2a3d66"
                           HorizontalOptions="Center"/>
                    
                    <!-- Filtros especÃ­ficos de medicamentos -->
                    <Frame BackgroundColor="#f5f5f5" Padding="10" CornerRadius="5" HasShadow="False">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Filtros de medicamentos:" 
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#2a3d66"/>
                            
                            <HorizontalStackLayout Spacing="10">
                                <Label Text="Medicamento:" 
                                       VerticalOptions="Center"
                                       TextColor="Black"
                                       WidthRequest="100"/>
                                <Picker ItemsSource="{Binding MedicationNames}"
                                        SelectedItem="{Binding SelectedMedicationFilter}"
                                        TextColor="Black"
                                        BackgroundColor="White"
                                        HorizontalOptions="FillAndExpand"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Frame>
                    
                    <ScrollView MaximumHeightRequest="400">
                        <CollectionView ItemsSource="{Binding FilteredMedicationHistory}"
                                        x:Name="MedicationHistoryCollectionView">
                            <CollectionView.EmptyView>
                                <StackLayout Padding="20" VerticalOptions="Center">
                                    <Label Text="ðŸ“­" 
                                           FontSize="48"
                                           HorizontalOptions="Center"
                                           Margin="0,20,0,10"/>
                                    <Label Text="No hay dosis confirmadas"
                                           TextColor="#999"
                                           FontAttributes="Italic"
                                           FontSize="16"
                                           HorizontalOptions="Center"/>
                                </StackLayout>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <SwipeView>
                                        <SwipeView.LeftItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Editar"
                                                           BackgroundColor="#2196F3"
                                                           Command="{Binding Source={x:Reference MedicationHistoryCollectionView}, Path=BindingContext.EditMedicationHistoryCommand}"
                                                           CommandParameter="{Binding .}"/>
                                            </SwipeItems>
                                        </SwipeView.LeftItems>
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Eliminar"
                                                           BackgroundColor="#f44336"
                                                           Command="{Binding Source={x:Reference MedicationHistoryCollectionView}, Path=BindingContext.DeleteMedicationHistoryCommand}"
                                                           CommandParameter="{Binding .}"/>
                                            </SwipeItems>
                                        </SwipeView.RightItems>
                                        <Frame BackgroundColor="#e8f5e9" 
                                               Padding="12" 
                                               Margin="0,5" 
                                               CornerRadius="8" 
                                               BorderColor="#4CAF50"
                                               HasShadow="False">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                                <Label Grid.Column="0" 
                                                       Text="{Binding FormattedTime}" 
                                                       FontAttributes="Bold"
                                                       FontSize="18"
                                                       TextColor="#4CAF50"
                                                       VerticalOptions="Center"/>
                                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                                    <HorizontalStackLayout Spacing="8">
                                                        <Label Text="{Binding MedicationName}" 
                                                               FontAttributes="Bold"
                                                               FontSize="16"
                                                               TextColor="Black"/>
                                                        <Label Text="âœ“" 
                                                               FontSize="18"
                                                               TextColor="#4CAF50"
                                                               FontAttributes="Bold"/>
                                                    </HorizontalStackLayout>
                                                    <Label Text="{Binding Dose}" 
                                                           FontSize="13"
                                                           TextColor="#666"/>
                                                    <Label Text="{Binding FormattedDate}" 
                                                           FontSize="12" 
                                                           TextColor="#888"/>
                                                </VerticalStackLayout>
                                                <Label Grid.Column="2" 
                                                       Text="{Binding UserType}"
                                                       FontSize="13"
                                                       FontAttributes="Bold"
                                                       TextColor="#2196F3"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Frame>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </ScrollView>

                    <!-- EstadÃ­sticas de medicamentos -->
                    <Frame BackgroundColor="#f0f0f0" 
                           Padding="15" 
                           CornerRadius="8" 
                           Margin="0,10,0,0"
                           HasShadow="False">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="ðŸ“Š EstadÃ­sticas de Medicamentos" 
                                   FontAttributes="Bold"
                                   FontSize="14"
                                   TextColor="#2a3d66"/>
                            <Label Text="{Binding TotalConfirmedDoses, StringFormat='Total de dosis confirmadas: {0}'}"
                                   FontSize="12"
                                   TextColor="#666"/>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </Frame>

            <!-- HISTORIAL DE ALIMENTOS -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="8" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ½ï¸ Historial de Alimentos" 
                           FontSize="22" 
                           FontAttributes="Bold" 
                           TextColor="#2a3d66"
                           HorizontalOptions="Center"/>
                    
                    <!-- Filtros especÃ­ficos de alimentos -->
                    <Frame BackgroundColor="#f5f5f5" Padding="10" CornerRadius="5" HasShadow="False">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="Filtros de alimentos:" 
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#2a3d66"/>
                            
                            <HorizontalStackLayout Spacing="10">
                                <Label Text="Tipo:" 
                                       VerticalOptions="Center"
                                       TextColor="Black"
                                       WidthRequest="100"/>
                                <Picker ItemsSource="{Binding FoodTypes}"
                                        SelectedItem="{Binding SelectedFoodTypeFilter}"
                                        TextColor="Black"
                                        BackgroundColor="White"
                                        HorizontalOptions="FillAndExpand"/>
                            </HorizontalStackLayout>

                            <HorizontalStackLayout Spacing="10">
                                <Label Text="Unidad:" 
                                       VerticalOptions="Center"
                                       TextColor="Black"
                                       WidthRequest="100"/>
                                <Picker ItemsSource="{Binding Units}"
                                        SelectedItem="{Binding SelectedUnitFilter}"
                                        TextColor="Black"
                                        BackgroundColor="White"
                                        HorizontalOptions="FillAndExpand"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Frame>
                    
                    <ScrollView MaximumHeightRequest="400">
                        <CollectionView ItemsSource="{Binding FilteredFoodHistory}"
                                        x:Name="FoodHistoryCollectionView">
                            <CollectionView.EmptyView>
                                <StackLayout Padding="20" VerticalOptions="Center">
                                    <Label Text="ðŸ½ï¸" 
                                           FontSize="48"
                                           HorizontalOptions="Center"
                                           Margin="0,20,0,10"/>
                                    <Label Text="No hay registros de alimentos"
                                           TextColor="#999"
                                           FontAttributes="Italic"
                                           FontSize="16"
                                           HorizontalOptions="Center"/>
                                </StackLayout>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <SwipeView>
                                        <SwipeView.LeftItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Editar"
                                                           BackgroundColor="#2196F3"
                                                           Command="{Binding Source={x:Reference FoodHistoryCollectionView}, Path=BindingContext.EditFoodCommand}"
                                                           CommandParameter="{Binding .}"/>
                                            </SwipeItems>
                                        </SwipeView.LeftItems>
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Eliminar"
                                                           BackgroundColor="#f44336"
                                                           Command="{Binding Source={x:Reference FoodHistoryCollectionView}, Path=BindingContext.DeleteFoodHistoryCommand}"
                                                           CommandParameter="{Binding .}"/>
                                            </SwipeItems>
                                        </SwipeView.RightItems>
                                        <Frame BackgroundColor="#fff3e0" 
                                               Padding="12" 
                                               Margin="0,5" 
                                               CornerRadius="8" 
                                               BorderColor="#FF9800"
                                               HasShadow="False">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                                <Label Grid.Column="0" 
                                                       Text="{Binding FormattedTime}" 
                                                       FontAttributes="Bold"
                                                       FontSize="18"
                                                       TextColor="#FF9800"
                                                       VerticalOptions="Center"/>
                                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                                    <Label Text="{Binding FoodType}" 
                                                           FontAttributes="Bold"
                                                           FontSize="16"
                                                           TextColor="Black"/>
                                                    <Label Text="{Binding DisplayAmount}" 
                                                           FontSize="13"
                                                           TextColor="#666"/>
                                                    <Label Text="{Binding FormattedDate}" 
                                                           FontSize="12" 
                                                           TextColor="#888"/>
                                                </VerticalStackLayout>
                                                <Label Grid.Column="2" 
                                                       Text="{Binding UserType}"
                                                       FontSize="13"
                                                       FontAttributes="Bold"
                                                       TextColor="#2196F3"
                                                       VerticalOptions="Center"/>
                                            </Grid>
                                        </Frame>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </ScrollView>

                    <!-- EstadÃ­sticas de alimentos -->
                    <Frame BackgroundColor="#f0f0f0" 
                           Padding="15" 
                           CornerRadius="8" 
                           Margin="0,10,0,0"
                           HasShadow="False">
                        <VerticalStackLayout Spacing="5">
                            <Label Text="ðŸ“Š EstadÃ­sticas de Alimentos" 
                                   FontAttributes="Bold"
                                   FontSize="14"
                                   TextColor="#2a3d66"/>
                            <Label Text="{Binding TotalFoodEntries, StringFormat='Total de registros: {0}'}"
                                   FontSize="12"
                                   TextColor="#666"/>
                            <Label Text="{Binding TotalFoodAmount, StringFormat='Cantidad total: {0:F1}'}"
                                   FontSize="12"
                                   TextColor="#666"/>
                            <Label Text="{Binding MostFrequentFoodType, StringFormat='Tipo mÃ¡s frecuente: {0}'}"
                                   FontSize="12"
                                   TextColor="#666"/>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </Frame>

            <!-- HISTORIAL DE CITAS MÃ‰DICAS -->
            <Frame BackgroundColor="#e8f5e8" Padding="15" CornerRadius="8" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="ðŸ“… Historial de Citas MÃ©dicas" 
                           FontSize="22" 
                           FontAttributes="Bold" 
                           TextColor="#2a3d66"
                           HorizontalOptions="Center"/>
                    
                    <Label Text="Citas Registradas:" 
                           FontAttributes="Bold" 
                           FontSize="16"
                           TextColor="#2a3d66"
                           Margin="0,10,0,5"/>
                    
                    <CollectionView ItemsSource="{Binding FilteredAppointments}" MaximumHeightRequest="300">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <SwipeView>
                                    <SwipeView.LeftItems>
                                        <SwipeItems>
                                            <SwipeItem Text="Confirmar"
                                                       BackgroundColor="#4CAF50"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HistoryViewModel}}, Path=ConfirmAppointmentCommand}"
                                                       CommandParameter="{Binding .}"
                                                       IsVisible="{Binding IsConfirmed, Converter={StaticResource InverseBoolConverter}}"/>
                                            <SwipeItem Text="Editar"
                                                       BackgroundColor="#2196F3"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HistoryViewModel}}, Path=EditAppointmentCommand}"
                                                       CommandParameter="{Binding .}"/>
                                        </SwipeItems>
                                    </SwipeView.LeftItems>
                                    <SwipeView.RightItems>
                                        <SwipeItems>
                                            <SwipeItem Text="Eliminar"
                                                       BackgroundColor="#f44336"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:HistoryViewModel}}, Path=DeleteAppointmentCommand}"
                                                       CommandParameter="{Binding .}"/>
                                        </SwipeItems>
                                    </SwipeView.RightItems>
                                    <Frame BackgroundColor="#f3e5f5" 
                                           Padding="10" 
                                           Margin="0,5" 
                                           CornerRadius="5"
                                           BorderColor="#9C27B0">
                                        <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10">
                                            <Label Grid.Column="0" 
                                                   Text="{Binding FormattedTime}" 
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   TextColor="#9C27B0"
                                                   VerticalOptions="Center"/>
                                            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                                <Label Text="{Binding Title}" 
                                                       FontAttributes="Bold"
                                                       TextColor="Black"/>
                                                <Label Text="{Binding Doctor}" 
                                                       FontSize="12"
                                                       TextColor="#666"
                                                       IsVisible="{Binding Doctor, Converter={StaticResource StringIsNotNullOrEmptyConverter}}"/>
                                                <Label Text="{Binding Location}" 
                                                       FontSize="12"
                                                       TextColor="#666"
                                                       IsVisible="{Binding Location, Converter={StaticResource StringIsNotNullOrEmptyConverter}}"/>
                                            </VerticalStackLayout>
                                            <Label Grid.Column="2" 
                                                   Text="âœ…"
                                                   FontSize="20"
                                                   IsVisible="{Binding IsConfirmed}"
                                                   VerticalOptions="Center"/>
                                            <Label Grid.Column="3" 
                                                   Text="{Binding FormattedDate}" 
                                                   FontSize="12"
                                                   TextColor="#666"
                                                   VerticalOptions="Center"/>
                                        </Grid>
                                    </Frame>
                                </SwipeView>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>

<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:TrackingApp.ViewModels"
             x:Class="TrackingApp.MainPage"
             Title="Tracking de Alimentos y Medicamentos">

    <ContentPage.BindingContext>
        <viewmodels:MainViewModel />
    </ContentPage.BindingContext>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Selector de Tipo de Usuario -->
            <Frame BackgroundColor="#2a3d66" Padding="15" CornerRadius="8">
                <HorizontalStackLayout Spacing="10">
                    <Label Text="Tipo de usuario:" TextColor="White" VerticalOptions="Center"/>
                    <Picker ItemsSource="{Binding UserTypes}"
                            SelectedItem="{Binding SelectedUserType}"
                            TextColor="White"
                            BackgroundColor="#1a2540"
                            HorizontalOptions="FillAndExpand"/>
                </HorizontalStackLayout>
            </Frame>

            <!-- Sección de Alimentos -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="8" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Registrar Alimento" FontSize="20" FontAttributes="Bold" TextColor="#2a3d66"/>
                    
                    <Entry Placeholder="Tipo de alimento" 
                           Text="{Binding FoodType}"
                           TextColor="Black"
                           PlaceholderColor="Gray"
                           BackgroundColor="#f5f5f5"/>
                    <HorizontalStackLayout Spacing="10">
                        <Entry Placeholder="Cantidad" 
                               Text="{Binding FoodAmount}" 
                               Keyboard="Numeric"
                               TextColor="Black"
                               PlaceholderColor="Gray"
                               BackgroundColor="#f5f5f5"
                               HorizontalOptions="FillAndExpand"/>
                        <Picker ItemsSource="{Binding Units}"
                                SelectedItem="{Binding FoodUnit}"
                                TextColor="Black"
                                BackgroundColor="#f5f5f5"
                                WidthRequest="80"/>
                    </HorizontalStackLayout>
                    <TimePicker Time="{Binding FoodTime}" 
                                Format="hh:mm tt"
                                TextColor="Black"
                                BackgroundColor="#f5f5f5"/>
                    <Button Text="Agregar Alimento" 
                            Command="{Binding AddFoodCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            FontAttributes="Bold"/>
                    
                </VerticalStackLayout>
            </Frame>

            <!-- Sección de Medicamentos -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="8" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Registrar Medicamento" FontSize="20" FontAttributes="Bold" TextColor="#2a3d66"/>
                    
                    <Entry Placeholder="Nombre del medicamento" 
                           Text="{Binding MedicationName}"
                           TextColor="Black"
                           PlaceholderColor="Gray"
                           BackgroundColor="#f5f5f5"/>
                    <Entry Placeholder="Dosis (ej: 5ml)" 
                           Text="{Binding MedicationDose}"
                           TextColor="Black"
                           PlaceholderColor="Gray"
                           BackgroundColor="#f5f5f5"/>
                    
                    <!-- Frecuencia: Horas y Minutos -->
                    <Label Text="Frecuencia:" FontAttributes="Bold" TextColor="#2a3d66"/>
                    <HorizontalStackLayout Spacing="10">
                        <VerticalStackLayout Spacing="5" HorizontalOptions="FillAndExpand">
                            <Label Text="Horas" FontSize="12" TextColor="Gray"/>
                            <Entry Placeholder="0" 
                                   Text="{Binding MedicationFrequencyHours}" 
                                   Keyboard="Numeric"
                                   TextColor="Black"
                                   PlaceholderColor="Gray"
                                   BackgroundColor="#f5f5f5"
                                   HorizontalOptions="FillAndExpand"/>
                        </VerticalStackLayout>
                        <VerticalStackLayout Spacing="5" HorizontalOptions="FillAndExpand">
                            <Label Text="Minutos" FontSize="12" TextColor="Gray"/>
                            <Entry Placeholder="30" 
                                   Text="{Binding MedicationFrequencyMinutes}" 
                                   Keyboard="Numeric"
                                   TextColor="Black"
                                   PlaceholderColor="Gray"
                                   BackgroundColor="#f5f5f5"
                                   HorizontalOptions="FillAndExpand"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    
                    <Label Text="Primera dosis:" FontSize="12" TextColor="Gray"/>
                    <TimePicker Time="{Binding MedicationTime}" 
                                Format="hh:mm tt"
                                TextColor="Black"
                                BackgroundColor="#f5f5f5"/>
                    <Button Text="Agregar Medicamento" 
                            Command="{Binding AddMedicationCommand}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            FontAttributes="Bold"/>
                    
                    <!-- SECCIÓN DE MEDICAMENTOS REGISTRADOS - MÁS VISIBLE -->
                    <Frame BackgroundColor="#fff3cd" 
                           BorderColor="#ffc107" 
                           Padding="10" 
                           Margin="0,15,0,0" 
                           CornerRadius="8"
                           HasShadow="True">
                        <VerticalStackLayout Spacing="10">
                            <HorizontalStackLayout Spacing="10">
                                <Label Text="💊" FontSize="24" VerticalOptions="Center"/>
                                <Label Text="Medicamentos Registrados" 
                                       FontAttributes="Bold" 
                                       FontSize="18"
                                       TextColor="#856404"
                                       VerticalOptions="Center"/>
                                <Label Text="{Binding FilteredMedications.Count, StringFormat='({0})'}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="#856404"
                                       VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                            
                            <!-- Instrucciones si no hay medicamentos -->
                            <Frame BackgroundColor="#d1ecf1" 
                                   Padding="10" 
                                   CornerRadius="5"
                                   IsVisible="{Binding FilteredMedications.Count, Converter={StaticResource InverseBoolConverter}}">
                                <Label Text="ℹ️ No hay medicamentos registrados. Agrega uno arriba para comenzar." 
                                       TextColor="#0c5460"
                                       FontSize="14"
                                       HorizontalTextAlignment="Center"/>
                            </Frame>
                            
                            <!-- Lista de medicamentos -->
                            <Frame BackgroundColor="White" 
                                   BorderColor="#ffc107" 
                                   Padding="5" 
                                   CornerRadius="5"
                                   IsVisible="{Binding FilteredMedications.Count}">
                                <VerticalStackLayout Spacing="5">
                                    <Label Text="👉 Desliza a la izquierda para EDITAR | Desliza a la derecha para ELIMINAR 👈" 
                                           FontSize="12"
                                           TextColor="#856404"
                                           HorizontalTextAlignment="Center"
                                           FontAttributes="Italic"
                                           Margin="0,0,0,5"/>
                                    
                                    <CollectionView ItemsSource="{Binding FilteredMedications}" 
                                                    MinimumHeightRequest="80"
                                                    MaximumHeightRequest="400">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <SwipeView>
                                                    <SwipeView.LeftItems>
                                                        <SwipeItems Mode="Reveal">
                                                            <SwipeItem Text="✏️ Editar"
                                                                       BackgroundColor="#2196F3"
                                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=EditMedicationCommand}"
                                                                       CommandParameter="{Binding .}"/>
                                                        </SwipeItems>
                                                    </SwipeView.LeftItems>
                                                    <SwipeView.RightItems>
                                                        <SwipeItems Mode="Reveal">
                                                            <SwipeItem Text="🗑️ Eliminar"
                                                                       BackgroundColor="#f44336"
                                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=DeleteMedicationCommand}"
                                                                       CommandParameter="{Binding .}"/>
                                                        </SwipeItems>
                                                    </SwipeView.RightItems>
                                                    <Frame BackgroundColor="#e3f2fd" 
                                                           Padding="12" 
                                                           Margin="2,3" 
                                                           CornerRadius="8"
                                                           BorderColor="#2196F3"
                                                           HasShadow="True">
                                                        <Label Text="{Binding DisplayText}" 
                                                               TextColor="#01579b"
                                                               FontSize="15"
                                                               FontAttributes="Bold"/>
                                                    </Frame>
                                                </SwipeView>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>
                            </Frame>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </Frame>

            <!-- Unificación: Calendario + Historial en una sola vista -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="8" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="📅💊 Eventos de Medicación (Calendario + Historial)" FontSize="20" FontAttributes="Bold" TextColor="#2a3d66"/>
                    
                    <!-- Controles -->
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="Días de cobertura:" 
                               VerticalOptions="Center"
                               TextColor="Black"
                               FontSize="14"/>
                        <Picker ItemsSource="{Binding DaysOptions}"
                                SelectedItem="{Binding SelectedDays}"
                                TextColor="Black"
                                BackgroundColor="#f5f5f5"
                                WidthRequest="80"/>
                        <Button Text="Actualizar" 
                                Command="{Binding RefreshCalendarCommand}"
                                BackgroundColor="#4CAF50"
                                TextColor="White"
                                FontAttributes="Bold"
                                HorizontalOptions="EndAndExpand"/>
                    </HorizontalStackLayout>

                    <!-- Filtro de medicamentos -->
                    <VerticalStackLayout Spacing="8" IsVisible="{Binding Medications.Count}">
                        <Label Text="{Binding SelectedMedicationFilterLabel}"
                               TextColor="#2196F3"
                               FontSize="14"
                               FontAttributes="Bold"/>
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="Medicamento:" 
                                   VerticalOptions="Center"
                                   TextColor="Black"
                                   FontSize="14"/>
                            <Picker ItemsSource="{Binding Medications}"
                                    ItemDisplayBinding="{Binding Name}"
                                    SelectedItem="{Binding SelectedMedication}"
                                    TextColor="Black"
                                    BackgroundColor="#f5f5f5"
                                    HorizontalOptions="FillAndExpand"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <!-- 📌 DOSIS PENDIENTES -->
                    <Label Text="⏰ Próximas Dosis" 
                           FontAttributes="Bold" 
                           FontSize="18"
                           TextColor="#2a3d66"
                           Margin="0,15,0,5"/>
                    
                    <ScrollView MaximumHeightRequest="400">
                        <CollectionView ItemsSource="{Binding PendingDoses}"
                                        x:Name="PendingDosesCollectionView">
                            <CollectionView.EmptyView>
                                <StackLayout Padding="20" VerticalOptions="Center">
                                    <Label Text="✅" 
                                           FontSize="48"
                                           HorizontalOptions="Center"
                                           Margin="0,20,0,10"/>
                                    <Label Text="No hay dosis pendientes"
                                           TextColor="#4CAF50"
                                           FontAttributes="Bold"
                                           FontSize="16"
                                           HorizontalOptions="Center"/>
                                </StackLayout>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Eliminar"
                                                           BackgroundColor="#f44336"
                                                           Command="{Binding Source={x:Reference PendingDosesCollectionView}, Path=BindingContext.DeleteEventCommand}"
                                                           CommandParameter="{Binding .}"/>
                                            </SwipeItems>
                                        </SwipeView.RightItems>
                                        <!-- Destacar la SIGUIENTE dosis -->
                                        <Frame Padding="12" 
                                               Margin="0,5" 
                                               CornerRadius="8" 
                                               BorderColor="{Binding IsNextDose, Converter={StaticResource BoolToNextDoseColorConverter}}"
                                               BackgroundColor="{Binding IsNextDose, Converter={StaticResource BoolToNextDoseBackgroundConverter}}">
                                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                                                <Label Grid.Column="0" 
                                                       Text="{Binding DisplayTime}" 
                                                       FontAttributes="Bold"
                                                       FontSize="18"
                                                       TextColor="{Binding IsNextDose, Converter={StaticResource BoolToNextDoseTextConverter}}"
                                                       VerticalOptions="Center"/>
                                                <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                                    <HorizontalStackLayout Spacing="8">
                                                        <Label Text="⏰ SIGUIENTE" 
                                                               FontSize="14"
                                                               TextColor="#FF6B35"
                                                               FontAttributes="Bold"
                                                               IsVisible="{Binding IsNextDose}"/>
                                                        <Label Text="{Binding MedicationName}" 
                                                               FontAttributes="Bold"
                                                               TextColor="Black"/>
                                                    </HorizontalStackLayout>
                                                    <Label Text="{Binding Dose}" 
                                                           FontSize="12"
                                                           TextColor="#666"/>
                                                </VerticalStackLayout>
                                                <Button Grid.Column="2" 
                                                        Text="Confirmar"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="{Binding IsNextDose, Converter={StaticResource BoolToConfirmButtonColorConverter}}"
                                                        TextColor="White"
                                                        FontAttributes="Bold"
                                                        FontSize="12"
                                                        Padding="10,8"
                                                        Clicked="OnConfirmButtonClicked"/>
                                            </Grid>
                                        </Frame>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </ScrollView>
                </VerticalStackLayout>
            </Frame>

            <!-- Sección de Citas Médicas -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="8" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="📅 Citas Médicas" FontSize="20" FontAttributes="Bold" TextColor="#2a3d66"/>
                    
                    <Entry Placeholder="Título de la cita" 
                           Text="{Binding AppointmentTitle}"
                           TextColor="Black"
                           PlaceholderColor="Gray"
                           BackgroundColor="#f5f5f5"/>
                    
                    <Entry Placeholder="Descripción (opcional)" 
                           Text="{Binding AppointmentDescription}"
                           TextColor="Black"
                           PlaceholderColor="Gray"
                           BackgroundColor="#f5f5f5"/>
                    
                    <Label Text="Fecha:" FontSize="12" TextColor="Gray"/>
                    <DatePicker Date="{Binding AppointmentDate}" 
                                TextColor="Black"
                                BackgroundColor="#f5f5f5"/>
                    
                    <Label Text="Hora:" FontSize="12" TextColor="Gray"/>
                    <TimePicker Time="{Binding AppointmentTime}" 
                                Format="hh:mm tt"
                                TextColor="Black"
                                BackgroundColor="#f5f5f5"/>
                    
                    <Entry Placeholder="Ubicación (opcional)" 
                           Text="{Binding AppointmentLocation}"
                           TextColor="Black"
                           PlaceholderColor="Gray"
                           BackgroundColor="#f5f5f5"/>
                    
                    <Entry Placeholder="Doctor (opcional)" 
                           Text="{Binding AppointmentDoctor}"
                           TextColor="Black"
                           PlaceholderColor="Gray"
                           BackgroundColor="#f5f5f5"/>
                    
                    <Button Text="Agregar Cita" 
                            Command="{Binding AddAppointmentCommand}"
                            BackgroundColor="#9C27B0"
                            TextColor="White"
                            FontAttributes="Bold"/>
                    
                    <Label Text="Citas Registradas:" 
                           FontAttributes="Bold" 
                           FontSize="16"
                           TextColor="#2a3d66"
                           Margin="0,10,0,5"/>
                    
                    <CollectionView ItemsSource="{Binding FilteredAppointments}" MaximumHeightRequest="250">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <SwipeView>
                                    <SwipeView.LeftItems>
                                        <SwipeItems>
                                            <SwipeItem Text="Editar"
                                                       BackgroundColor="#2196F3"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=EditAppointmentCommand}"
                                                       CommandParameter="{Binding .}"/>
                                        </SwipeItems>
                                    </SwipeView.LeftItems>
                                    <SwipeView.RightItems>
                                        <SwipeItems>
                                            <SwipeItem Text="Eliminar"
                                                       BackgroundColor="#f44336"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=DeleteAppointmentCommand}"
                                                       CommandParameter="{Binding .}"/>
                                        </SwipeItems>
                                    </SwipeView.RightItems>
                                    <Frame BackgroundColor="#f3e5f5" 
                                           Padding="10" 
                                           Margin="0,5" 
                                           CornerRadius="5"
                                           BorderColor="#9C27B0">
                                        <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10">
                                            <Label Grid.Column="0" 
                                                   Text="{Binding FormattedTime}" 
                                                   FontAttributes="Bold"
                                                   FontSize="16"
                                                   TextColor="#9C27B0"
                                                   VerticalOptions="Center"/>
                                            <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                                <Label Text="{Binding Title}" 
                                                       FontAttributes="Bold"
                                                       TextColor="Black"/>
                                                <Label Text="{Binding Doctor}" 
                                                       FontSize="12"
                                                       TextColor="#666"
                                                       IsVisible="{Binding Doctor, Converter={StaticResource StringIsNotNullOrEmptyConverter}}"/>
                                                <Label Text="{Binding Location}" 
                                                       FontSize="12"
                                                       TextColor="#666"
                                                       IsVisible="{Binding Location, Converter={StaticResource StringIsNotNullOrEmptyConverter}}"/>
                                            </VerticalStackLayout>
                                            <Label Grid.Column="2" 
                                                   Text="{Binding FormattedDate}" 
                                                   FontSize="12"
                                                   TextColor="#666"
                                                   VerticalOptions="Center"/>
                                            <Button Grid.Column="3" 
                                                    Text="Confirmar"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="{Binding IsConfirmed, Converter={StaticResource BoolToConfirmButtonColorConverter}}"
                                                    TextColor="White"
                                                    FontAttributes="Bold"
                                                    FontSize="12"
                                                    Padding="10,8"
                                                    Clicked="OnConfirmAppointmentButtonClicked"
                                                    IsEnabled="{Binding IsConfirmed, Converter={StaticResource InverseBoolConverter}}"/>
                                        </Grid>
                                    </Frame>
                                </SwipeView>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- Botón de Restablecer Todo -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="8" HasShadow="True" Margin="0,10,0,0">
                <VerticalStackLayout Spacing="10">
                    <Label Text="⚠️ Zona de Peligro" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           TextColor="#f44336"
                           HorizontalOptions="Center"/>
                    <Label Text="Esta acción eliminará TODOS los datos de forma permanente"
                           FontSize="12"
                           TextColor="#666"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center"/>
                    <Button Text="🗑️ Restablecer Todo"
                            Command="{Binding ResetAllDataCommand}"
                            BackgroundColor="#f44336"
                            TextColor="White"
                            FontAttributes="Bold"
                            HorizontalOptions="Center"
                            WidthRequest="250"/>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>